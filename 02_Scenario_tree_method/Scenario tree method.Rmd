---
title: "Scenario Tree analysis"
subtitle: "09:30 - 10:00"
author: "Eleftherios Meletis, AurÃ©lien Madouasse"
date: "2022-03-23"
output:
  xaringan::moon_reader:
    css: ["default"]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: 16/9
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


class: inverse, center, middle

## Scenario tree method - Introduction

Reference quantitative method to estimate the probabilities of freedom from infection from complex surveillance systems

> Answers to:

* If infection was present at the design prevalence, what would be the probability of the surveillance system detecting at least 1 case?
 **Surveillance sensitivity**
* Given that no cases have been detected, what is the probability that true infection prevalence is lower than the design prevalence?
 **Probability of freedom from infection**

> Principle: A surveillance system is represented as a tree with different components

---

## Scenario tree method - Simple Example

We will go through a simple example that will help understand
* (i) Scenario tree notation 
* (ii) Scenario tree calculations



Objective: Estimation of the probability of freedom from Bovine Viral Diarrhea virus (BVDV) in country A 

---

The following figure shows the structure of the surveillance system.

![](figs/simple_scenario_tree.png)

---

The surveillance system is split, given the herd type, to dairy and beef cattle.

We assume that design prevalence is the same for both dairy and beef cattle.

Given the herd type a different diagnostic method to detect infection is applied.
* Dairy - Bulk Tank Milk
* Beef - Blood  sample [e.g., serum ELISA]

---

## Scenario tree notation

* Herd type - (Risk) Category node
* Herd status - Infection node
* BTM test / Blood test - Detection node

> 
* Risk Category node - represent factors dividing the SSC population into subsets with different probabilities of being infected
* Infection node - represent the infection status, branch probabilities derived from design prevalence [Infected - Uninfected]
* Detection node - represent the detection of infection, associated with test characteristics [Positive - Negative] 

*Branch proportions at each category node must sum to 1*

**Our surveillance system has two surveillance components, that are complementary**

---

## Scenario tree calculations 

> Scenario tree constraints
* All final results from the SS are consistent with country or zone freedom from infection
* Specificity of the surveillance system is 100% 

Complex Surveillance systems have more than one detection nodes (see Example later)

Units with a positive test outcome are retested (with a "better" method).

>The process of repeated testing (sequential testing)
* (I) Reduces the probability of a false-positive output in the surveillance system (Sp of SS = 1)
* (II) If a true-positive unit is detected then the country's/zone's claim freedom from infection is no longer valid and the method is no longer applicable

---

# Simple Example - R code

#### Input parameters

* Design prevalence
* Test characteristics of BTM and Blood test
* Number of herds tested, per herd type


``` {r}
# Design prevalence
p_design = 0.02

#Test characteristics
# BTM test
Se_BTM = 0.9
Sp_BTM = 1
# Blood test
Se_Blood = 0.95
Sp_Blood = 1

# Number of herds tested, per herd type - different scenario given sample size
n_dairy = seq(10,400,20)
n_beef = seq(10,600,10)
```

---

### Estimate Surveillance component sensitivity

$$
SCSe = 1 - (1 - p^* *Se^unit^)
$$

$$
OverallSSe = 1 -mul_{i=1}^{n}{1 - SCSe_n}
$$

```{r}
CSE_dairy = 1 - (1-(p_design*Se_BTM))^n_dairy
CSE_beef = 1 - (1-(p_design*Se_Blood))^n_beef

Overall_SSE = 1 - (1-CSE_dairy)*(1-CSE_beef)
```

---
## Estimate probability of freedom from infection

$$
Pr_freedom = Pr(D^- | S^-) = Negative  Predictive  Value
$$
Using Bayes rule

$$
Pr_freedom = Pr(D^- | S^-) = \frac{Pr(S^- | D^-) Pr(D^-) )}{Pr(S^-)} = \frac{Pr(S^- | D^-) Pr(D^-) )}{Pr(S^- | D^-) Pr(D^-) + Pr(S^-|D^+)*Pr(D^+)} =
\frac{Sp_SS * (1-p^*)}{Sp_SS * (1-p^*) + (1 - Se_SS)*P^*}
$$

We assume that Sp_SS = 1 then

$$
Pr_freedom = Pr(D^- | S^-)=
\frac{(1-p^*)}{(1-p^*) + (1 - Se_SS)*P^*}
$$

```{r}
P_freedom = (1-p_design)/((1-p_design) + p_design*(1-Overall_SSE))
```

---

## Another example - Exercise

### Introducing the Adjusted risk

Suppose the following scenario

SS for BVDV
Country X has 2 regions - herds divided by herd type to beef and dairy cattle

Dairy cattle tested by BTM - if positive retested 
Beef cattle tested with ELISA - if positive retested

Region 2 is sharing borders with a country that is known to be BVDV-positive - higher risk
Relative_risk(region_2) = 4*Relative_risk(region_1) = 4
Relative_risk(region_1) = 1

80% of the herds belong to Region 1
20% of the herds belong to Region 2

Herd type > 40% beef, 60% dairy cattle

Design prevalence = 0.02


---

## If we have time - explain p_Intro
---

## Packages appliying the scenario method
Load libraries
```{r}
library(epiR)
```

```{r}
#rsu.pfree.rs(se.p, p.intro = 0, prior = 0.5, by.time = TRUE)
```







