---
title: "Scenario Tree Analysis"
subtitle: "09:30 - 10:00"
author: "Eleftherios Meletis, AurÃ©lien Madouasse"
date: "2022-03-23"
output:
  xaringan::moon_reader:
    css: ["default"]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: 16/9
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```




## Scenario tree method - Introduction

Reference quantitative method to estimate the probability of freedom from infection from complex surveillance systems

> Answers to:

* If infection was present at the design prevalence, what would be the probability of the surveillance system detecting at least 1 case?
 **Surveillance sensitivity**
* Given that no cases have been detected, what is the probability that the true prevalence of infection is lower than the design prevalence?
 **Probability of freedom from infection**

> Principle: A surveillance system is represented as a tree with different components

---

## Scenario tree method - Simple Example

We will go through a simple example that will help understand
* (i) Scenario tree notation 
* (ii) Scenario tree calculations



Objective: Estimation of the probability of freedom from Bovine Viral Diarrhea virus (BVDV) in country A 

---

The following figure shows the structure of the surveillance system.

![](figs/simple_scenario_tree.png)

---

The surveillance system is split, given the herd type, to dairy and beef cattle.

We assume that the design prevalence is the same for both dairy and beef cattle.

Given the herd type a different diagnostic method to detect infection is applied.
* Dairy - Bulk Tank Milk
* Beef - Blood  sample [e.g., serum ELISA]

---

## Scenario tree notation

* Herd type - (Risk) Category node
* Herd status - Infection node
* BTM test / Blood test - Detection node

> 
* (Risk) Category node - represent (risk) factors dividing the surveillance system population into subsets with different probabilities of being infected
* Infection node - represent the infection status, branch probabilities derived from design prevalence [Infected - Uninfected]
* Detection node - represent the detection of infection, associated with test characteristics [Positive - Negative] 

*Branch proportions at each category node must sum to 1*

**Our surveillance system has two surveillance components, that are complementary**

---

## Scenario tree calculations 

> Scenario tree constraints
* All final results from the surveillance system are consistent with country or zone freedom from infection
* Specificity of the surveillance system is 100% 

Complex Surveillance systems have more than one detection nodes (see Example later)

Units with a positive test outcome at the first detection node are retested (with a "better" method, "maybe more expensive method). The final result has to be negative.

>The process of repeated testing (sequential testing)
* (I) Reduces the probability of a false-positive output in the surveillance system (SS) (Sp of SS = 1)
* (II) If a true-positive unit is detected then the country's/zone's claim of freedom from infection is no longer valid and the method is no longer applicable


Often the specificities of the individual methods applied are considered 100%

---

# Simple Example - R code

#### Input parameters

* Design prevalence
* Test characteristics of BTM and Blood test
* Number of herds tested, per herd type


``` {r}
# Design prevalence
p_design = 0.02

#Test characteristics
# BTM test
Se_BTM = 0.9
Sp_BTM = 1
# Blood test
Se_Blood = 0.95
Sp_Blood = 1

# Number of herds tested, per herd type - different scenario given sample size
n_dairy = seq(10,400,20)
n_beef = seq(10,600,10)
```

---

### Estimate Surveillance component sensitivity

$$
SCSe = 1 - (1 - p^* *Se^unit^)
$$

$$
OverallSSe = 1 -mul_{i=1}^{n}{1 - SCSe_n}
$$

```{r}
CSE_dairy = 1 - (1-(p_design*Se_BTM))^n_dairy
CSE_beef = 1 - (1-(p_design*Se_Blood))^n_beef

Overall_SSE = 1 - (1-CSE_dairy)*(1-CSE_beef)
```

Compare efficacies of the two surveilance system compomenets - Sensitivty ratio 

*Critical value is 1*

```{r}
Sensitivity_ratio = CSE_dairy/CSE_beef
```
---
## Estimate probability of freedom from infection

$$
Pr_freedom = Pr(D^- | S^-) = Negative  Predictive  Value
$$
Using Bayes rule

$$
Pr_freedom = Pr(D^- | S^-) = \frac{Pr(S^- | D^-) Pr(D^-) )}{Pr(S^-)} = \frac{Pr(S^- | D^-) Pr(D^-) )}{Pr(S^- | D^-) Pr(D^-) + Pr(S^-|D^+)*Pr(D^+)} =
\frac{Sp_SS * (1-p^*)}{Sp_SS * (1-p^*) + (1 - Se_SS)*P^*}
$$

We assume that Sp_SS = 1 then

$$
Pr_freedom = Pr(D^- | S^-)=
\frac{(1-p^*)}{(1-p^*) + (1 - Se_SS)*P^*}
$$

```{r}
P_freedom = (1-p_design)/((1-p_design) + p_design*(1-Overall_SSE))
```

---

## Another example - Exercise

### Introducing the Adjusted risk

Suppose the following scenario

SS for BVDV
Country X has 2 regions - herds divided by herd type to beef and dairy cattle

Dairy cattle tested by BTM - if positive retested 
Beef cattle tested with ELISA - if positive retested

Region 2 is sharing borders with a country that is known to be BVDV-positive - higher risk
Relative_risk(region_2) = 4*Relative_risk(region_1) = 4
Relative_risk(region_1) = 1

80% of the herds belong to Region 1
20% of the herds belong to Region 2

Herd type > 40% beef, 60% dairy cattle

Design prevalence = 0.02

---

Given the information we have on the SS we can construct the scenario tree.

![](figs/second_example_scenario_tree.png)

---

Now region is a risk category node! 

The available relative risks have to be adjusted given the proportion of the population in each branch of the node.

The output value is known as **Adjusted Risk**.

---

##Calculation of Adjusted Risk

### Key Points

* Ratio of adjusted risks must remain the same as the original relative risk - AR_1/AR_2 = RR_1/RR_2 (1)
* The average risk across the population is equal to 1 - AR_1 * Pr(Region_1) + AR_2 * Pr_(Region_2) = 1 (2)

From (1) we have
RR_1 = 1
AR_2 = RR_2*AR_1 (3)


From (2) using (3) we conclude that
AR_1 = 1/(Pr(Region_1) + RR_2*Pr(Region_2))

```{r}
RR_1 = 1
RR_2 = 4
P_region_1 = 0.8
P_region_2 = 0.2
```

```{r}
AR_1 = 1/(P_region_1 + RR_2*P_region_2)
AR_2 = RR_2 * AR_1
```

---
## Effective probability of infection


! As a last step we have to adjust for the design prevalence

The output is defined as Effective Probability of infection (EPI) is equal to

EPI = AR*p_design

```{r}
p_design = 0.02
EPI_1 = AR_1*p_design
EPI_2 = AR_2*p_design
```

---

## Repeated testing

As pointed out if an unit tests positive in the first round of testing then it is retested with the same test.

Assumming independence between tests the overall sensitivity of the sequential testing is the product of the individual sensitivities

```{r}
#Test characteristics
# BTM test
Se_BTM = 0.9
Sp_BTM = 1
# Blood test
Se_Blood = 0.95
Sp_Blood = 1

Seq_Dairy = Se_BTM^2
Seq_Blood = Se_Blood^2
```


---

## Surveillance Sensitivity

We are now ready to estimate the component and overall suveillance sensitivity

```{r}
CSE_A_dairy = 1 - (1-(EPI_1*Seq_Dairy))^n_dairy
CSE_A_beef = 1 - (1-(EPI_1*Seq_Blood))^n_beef

CSE_B_dairy = 1 - (1-(EPI_2*Seq_Dairy))^n_dairy
CSE_B_beef = 1 - (1-(EPI_2*Seq_Blood))^n_beef

Overall_SSE = 1 - (1-CSE_A_dairy)*(1-CSE_A_beef)*(1-CSE_B_dairy)*(1 - CSE_B_beef)

```